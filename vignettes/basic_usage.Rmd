---
title: "rd4 basic usage"
author: 
  - Pamela Russell
  - Seth Stadick
package: rd4
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{rd4 Basic Usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

The Dense Depth Data Dump (D4) format provides fast analysis and compact storage of quantitative genomics datasets, and is generally an efficient alternative to existing formats such as bedGraph and BigWig. It supports random access, multiple tracks (e.g. different data types or samples), and summary statistics on arbitrary genomic intervals. For full details on the format, see [Hou et al.](https://doi.org/10.1038/s43588-021-00085-0).

`rd4` is the first package providing R bindings for reading and querying D4 files, and is similar in scope to the existing Python library [pyd4](https://github.com/38/pyd4). `rd4` provides functions to open a D4 file, explore its contents, and extract summary statistics and complete data for arbitrary genomic intervals. 

Additionally, `rd4` enables seamless Bioconductor workflows through support for the standard genomic annotation package [GenomicRanges](https://bioconductor.org/packages/release/bioc/html/GenomicRanges.html). Most query functions provide a batch version that can take in a `GRanges` object, run a query for each interval in the container, and populate interval metadata with query results.


# Installation

## From Bioconductor

```{r eval = FALSE}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("rd4")
```

## From GitHub

```{r eval = FALSE}
devtools::install_github("fulcrumgenomics/rd4")
```


# Package usage

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

## Load dependencies for the vignette

```{r setup}
suppressPackageStartupMessages(library(rd4))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(knitr))
```

## Locate and load the example D4 file

```{r load_d4}
d4_path <- system.file("extdata", "example.d4", package="rd4")
d4source <- D4Source(d4_path)
```

## Explore some basic features of the data

Chromosome names and lengths

```{r chrs}
chrs <- get_chroms(d4source)
head(rbindlist(chrs))
```

Track names

```{r tracks}
get_tracks(d4source)
```

## Explore data values across a genomic region

Region coordinates are 0-based, half-open.

### Summary statistics

For these and below functions, omitting the track name parameter causes the first track to be queried.

```{r summary_notrack}
mean(d4source, "chr1", 17027500, 17027600)
median(d4source, chr = "chr1", start = 17027500, end = 17027600)
percentile(d4source, "chr1", 17027500, 17027600, 50)
```

Query a specific track:

```{r summary_track}
mean(d4source, "chr3", 0, 100000000, track = "track2")
median(d4source, chr = "chr3", start = 0, end = 100000000, track = "track2")
percentile(d4source, "chr3", 0, 100000000, 99, track = "track2")
percentile(d4source, "chr3", 0, 100000000, 99.999, track = "track2")
```

### Vector of data values

```{r query}
# Query a genomic interval
query <- query(d4source, "chr1", 17027500, 17027600)

# Fields in the result object
names(query)

# Vector of data values
query$results

# The query that was supplied
query$query

# The same region on the minus strand
query(d4source, "chr1", 17027500, 17027600, minus_strand =TRUE)$results
```

## Resample a region

This operation reduces the resolution of the data vector, summarizing values at the level of the bin size and returning a new query result.

```{r resample}
query_resample <- resample(
  d4source, "chr1", 17027500, 17027600, method = "mean", bin_size = 10)

# The result has the same structure as a `query()` result
names(query_resample)

# Values are summarized per bin
query_resample$results

# The bin_size field is set
query_resample$bin_size
```

## Working with `GenomicRanges` `Granges` objects

[GenomicRanges](https://bioconductor.org/packages/release/bioc/html/GenomicRanges.html) is the [Bioconductor](https://bioconductor.org/) package for representation and manipulation of genomic intervals. `rd4` provides methods to batch query a D4 file with all intervals in a `GRanges` object, updating the metadata for each genomic range with the values from the D4 data.

Each method returns a new `GRanges` object with updated metadata.

```{r granges}
# Manually construct a GRanges object with the above genomic interval and one 
# other interval
# `IRanges` coordinates are 1-based inclusive
granges <- GRanges(
  seqnames = "chr1", 
  ranges = IRanges(start = c(17027501, 17027701), end = c(17027600, 17027800)), 
  strand = "+"
)

# Add summary statistics as interval metadata
granges <- update_mean(d4source, granges)
granges <- update_median(d4source, granges)
granges <- update_percentile(d4source, granges, 25)
granges <- update_percentile(d4source, granges, 50)
granges <- update_percentile(d4source, granges, 75)

# View populated metadata
print(granges)
kable(mcols(granges))

# Add position-level values as interval metadata
granges <- update_query_results(d4source, granges)
lapply(mcols(granges)$query_results, function(result) result$results)
```

## Session info

```{r session_info}
sessionInfo()
```
